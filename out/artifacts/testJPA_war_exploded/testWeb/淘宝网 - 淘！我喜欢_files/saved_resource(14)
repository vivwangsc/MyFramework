/*! market 2015-12-05 */
KISSY.add("tbc/market/1.3.31/getHelper",function(a,b,c){"use strict";function d(a){this.init(a)}a.config({packages:{"sd/data_sufei":{base:"//g.alicdn.com/sd/data_sufei/1.3.5/sufei",ignorePackageNameInUri:!0,charset:"utf8"}}});var e={request:{merge:{maxBlock:20,maxCount:80,maxTime:300,outTime:100},jsonp:{callback:"callback"},url:"",backupUrl:"",parameters:{},split:",;|"},response:{convert:{},path:""}};return a.augment(d,{init:function(b){var c=this;c.conf=a.merge(c.conf,a.clone(e)),a.mix(c.conf,b,!0,null,!0),c.conf.request.merge&&c.conf.request.mergeKey&&(c._path=c.conf.request.mergeKey.split(">")),c._init()},_init:function(){var a=this;a._stack=[],a._resultSuccess={},a._block={},a._count=0,a._blockCount=0,a._startTime=null},_val:function(a,b){return b.replace(/\$\{([^}]*)\}/g,function(b,c){return a[c]||""})},_valResponse:function(a,b){return b.replace(/@\{([^}]*)\}/g,function(b,c){return a[c]})},countItem:function(){var a=this;return a.conf.request.mergeCount},_paraTr:function(a,b){var c=this,d={};for(var e in b)b.hasOwnProperty(e)&&(d[e]=c._val(a,b[e]));return d},push:function(b,c){var d,e=this,f=e.conf.request,g=f.merge,h=f.mergeKey,i=f.mergeCount,j=e._path,k=f.parameters,l={para:b,cb:c};if(d=e._paraTr(b,k),d=a.merge(d,b),g&&h){e._startTime=e._startTime||new Date,i&&(""==d[i]?l.count="":l.count=parseInt(d[i],10),e._count+l.count>g.maxCount&&e._count>0&&e._do(),e._count+=l.count);for(var m=e._block,n=!1,o=0;o<j.length;o+=1){var p=d[j[o]];if(o+1==j.length)if(m[p]){var q=!1;if(a.each(m[p],function(a,b){return m[p][b]==d[b]||(i?b==i:1)?!0:(q=!0,!1)}),q)return e._do(),e.push(b,c),e;i&&(m[p][i]+=d[i]?parseInt(d[i],10):"")}else{var r={};for(var s in d)d.hasOwnProperty(s)&&(a.inArray(s,j)||(i===s?r[s]=d[s]?parseInt(d[s],10):"":r[s]=d[s]));m[p]=r,n=!0}else m[p]||(m[p]={},n=!0),m=m[p]}if(e._stack.push(l),n&&(e._blockCount+=1,e._blockCount>=g.maxBlock))return e._do(),e;new Date-e._startTime>g.maxTime?e._do():(clearTimeout(e._timer),e._timer=setTimeout(function(){e._do()},g.outTime))}else e._stack.push(l),e._do(d),e._init(),clearTimeout(e._timer);return e},_getPara:function(){var a=this,b=a.conf.request,c=a._path,d=b.split.split(""),e=c.length,f=a._block,g=function(a,b,c){var f={};if(f[a[0]]=[],a.length>1){for(var h in b)if(b.hasOwnProperty(h)){f[a[0]].push(h);var i=g(a.slice(1),b[h],c+1);for(var j in i)i.hasOwnProperty(j)&&(f[j]||(f[j]=[]),f[j].push(i[j]))}}else{var k=0;for(var l in b){if(b.hasOwnProperty(l)){f[a[0]].push(l);var m=0;for(var n in b[l])b[l].hasOwnProperty(n)&&(f[n]||(f[n]=[]),f[n][k]=b[l][n]),m++}k++}for(var o in f)f[o].length!==k&&(f[o].length=k)}for(var p in f)f.hasOwnProperty(p)&&(f[p]=f[p].join(d[e-c-1]));return f};return g(c,f,0)},_do:function(a){var b=this,d=b._stack;b[c.stringify(a)]=!1;var e=a||b._getPara(),f=b.conf.request.url,g=b.conf.request.backupUrl,h=function(f){b._assign(f,d,function(){b._jt_send(e,"warn","Have no data"),g&&b._get(e,b.conf.request.backupUrl,h),b[c.stringify(a)]=!0},a)};b._get(e,f,h,function(){g&&b._get(e,b.conf.request.backupUrl,h,function(){b._jt_send(e,"cdnerror","Interface hung up")}),b[c.stringify(a)]=!0,b._jt_send(e,"error","Interface hung up")}),b._init(),clearTimeout(b._timer)},_get:function(c,d,e,f){var g=this,h=(g.conf.request.jsonp.callback,function(b){var c=[];return a.each(b,function(a,b){c.push(b+"="+a)}),c.join("&")});if(g.conf.request.cacheTime)var i=g._getCbName(c,d);else var i="jsonp"+a.guid();return a.use("sd/data_sufei/sufei",function(a,j){b(j({url:d+(d.indexOf("?")<0?"?":"&")+h(c),success:function(a){e&&e(a)},error:function(){f&&f()},dataType:"jsonp",jsonpCallback:i,cache:!0,scriptCharset:"utf-8",timeout:g.conf.request.timeout,crossDomain:!0},{style:"taobao"}))}),g},_getCbName:function(b,c){var d=this,e="jsonp";try{e+=b.tce_sid.replace(/,/g,"");var f=c.indexOf("dispatch")>-1?"d":"n";e+=f;var g=d.conf.request.cacheTime;e+=parseInt(+new Date/g/1e3)}catch(h){e+=a.guid()}return e},_assign:function(b,d,e,f){var g,h,i,j,k,l=this,m=l.conf.response,n=m.convert,o=m.path.split("."),p=l.conf.request.backupUrl;for(n&&n.path&&(j=n.path.split("."),k=b,a.each(j,function(a){k=k[a]}),i={},a.each(k,function(a){i[l._valResponse(a,n.key)]=a}),b=i),g=0;g<d.length;g+=1){for(i=b||[],h=0;h<o.length;h+=1)i=i[l._val(d[g].para,o[h])]||[];if(a.isArray(i)&&0===i.length&&!l[c.stringify(f)]&&l.conf.request.backupUrl&&p)return e&&e(),!1;a.isArray(i)&&0===i.length&&l[c.stringify(f)]&&l._jt_send(f,"cdnwarn","Have no data"),l[c.stringify(f)]||0===i.length||(l._resultSuccess[c.stringify(d[g].para)]="success"),d[g].count&&(i=a.isArray(i)?i.splice(0,d[g].count):[]),a.isFunction(d[g].cb)&&(l[c.stringify(f)]&&!l._resultSuccess[c.stringify(d[g].para)]&&d[g].cb(i,d[g].para),l[c.stringify(f)]||d[g].cb(i,d[g].para))}},_jt_send:function(b,c,d){var e=this;if(b){var f=a.clone(b);f.msg=d,window.JSTracker?e._send_js(f,c):a.getScript("//g.alicdn.com/tb/tracker/1.0.17/index.js",function(){e._send_js(f,c)})}else window.JSTracker?e._send_js({msg:"error"},c):a.getScript("//g.alicdn.com/tb/tracker/1.0.17/index.js",function(){e._send_js({msg:"error"},c)})},_send_js:function(a,b){var a=c.stringify(a),d={msg:a,file:window.location,url:"https://xctrljstrasker.taobao.com/market/0.0.1/"+b};try{var e=goldlog.spm_ab;"a21bo.7724922"===e.join(".")&&(d.sampling=1,d.url="https://xctrljstrasker.taobao.com/taobao/0.0.1/"+b)}catch(f){}JSTracker.send(d)}}),d},{requires:["ajax","json"]});