/*! market 2015-12-05 */
KISSY.add("tbc/market/1.3.31/xctrl",function(S,api,UA,JSON,IO,Event){"use strict";function Multi(a){this.cfg=S.merge(defaultConfig,a),this.init(this.cfg)}var defaultConfig={timeout:3e3};S.augment(Multi,Event.Target,{init:function(a){var b=this;b.cfg=a,b._stringfiyToResult(a)},_stringfiyToResult:function(conf){var self=this;if(window.JSON)var data=S.isString(conf.data)?JSON.parse(conf.data):conf.data;else var data=S.isString(conf.data)?eval("("+conf.data+")"):conf.data;var key=conf.key,cb=conf.callback,p=conf.extra,arr=data[key];self.RequestFind=S.clone(data),arr&&S.isArray(arr)&&""!=arr?self._getData(arr,key,cb,p):(cb(arr),arr?""==arr?self.log("data['"+key+"'] has nothing"):self.log("data['"+key+"'] is not a array, tms coun't resolve it"):self.log(key+" is undefiend"))},_getData:function(a,b,c,d){var e,f=this,g=[],h={};return S.each(a,function(i,j){var k,l,m=i.data_type,n=i.data_para,o=i.data_request;for(var p in i)S.isArray(i[p])&&(k=p,l=i[p]);if(n=o?f.checkRely(i):n,n=d?S.merge(n,d):n,m)if(e=api.use(m)){for(var q in n)if(n.hasOwnProperty(q)){try{n[q]=unescape(n[q])}catch(r){}n[q]=encodeURIComponent(S.trim(n[q]))}e.push(n,function(d){if(d&&S.isArray(d)&&""!=d){var d=f._GetMsgWhitCommit(d);S.each(d,function(b,c){o&&(b.data_request=o),k&&(l[0].data_request=b,b[k]=S.clone(l)),a[c]=b}),h[b]=a,c&&c(h),clearTimeout(g[j])}else S.log("\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u03aa\ufffd\u0563\ufffd\ufffd\ufffd\ufffd\xf1\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd."),h[b]=[],c&&c(h)})}else S.log(m,"api \ufffd\ufffd\u0427");else{var s=S.clone(i);for(var p in i)S.isArray(i[p])&&(delete s[p],S.each(i[p],function(a,b){a.data_request=s}))}}),a[0].data_type||(h[b]=a,c&&c(h)),!1},_toEachArr:function(a,b,c){var d=this;d.promise[b]={},d.promise[b].get=0,d.promise[b].len=a.length,d._postRequst(a,b,c)},_GetMsgWhitCommit:function(a){function b(a,b){for(var d,e=0,f=a.length;f>e;e++){var g=a[e],h=!0;for(var i in g)S.isString(g[i])&&b[i]!==g[i]&&(h=!1),S.isArray(g[i])&&(d=i);if(h){a=g[d];break}}if(!h)var a=c(a,b);return a}function c(a,b){for(var c,d=0,e=a.length;e>d;d++){var f=a[d],g=!1;for(var h in f)"cat_id"===h&&f[h]===b[h]&&(g=!0),S.isArray(f[h])&&(c=h);if(g){a=f[c];break}}return a}var d=this,e=S.clone(a),f=d.RequestFind;if(f.moduleinfo)return e;if(f.data_request){var g=f.data_request,h=b(e,g);e=b(h,f)}else e=b(e,f);return e},_jstracker_send:function(a,b){a=JSON.stringify(a),JSTracker.config("sampling",1),JSTracker.send({msg:a,file:window.location,category:b,url:"//tms.taobao.com/xctrl"})},checkRely:function(a){var b=a.data_para;for(var c in b){var d=decodeURIComponent(b[c]),e=/@/g,f=d.match(e),g=f?f.length:0,h=null;if(g>0){for(var i=d.replace(e,""),j=0;g>j;j++)h=h?h.data_request:a.data_request;b[c]=h[i]}}return b},log:function(a){window.console&&console.log(S.clone(a))}});var XCtrl;return XCtrl={dynamic:function(a,b,c,d){new Multi(arguments.length>1?{data:a,key:b,callback:c,extra:d}:arguments[0])}}},{requires:["tms/api","ua","json","io","event"]});